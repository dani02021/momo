{% extends 'admin1/base.html' %}
{% load static %}
{% block content %}
{% for message in messages %}
{% if message|stringformat:'s' == 'role_exists' %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
  <strong>Role already exists!</strong>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}
{% if message|stringformat:'s' == 'role_created' %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
  <strong>Role is created!</strong>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}
{% if message|stringformat:'s' == 'role_deleted' %}
<div class="alert alert-warning alert-dismissible fade show" role="alert">
  <strong>Selected roles are deleted!</strong>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}
{% if message|stringformat:'s' == 'role_edited' %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
  <strong>Role is edited!</strong>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}
{% endfor %}
<style>
  .ui-autocomplete-loading {
    background: white url("{% static 'img/ui-anim_basic_16x16.gif' %}") right center no-repeat;
  }
</style>
<div class="container mt-5">
  <div class="row tm-content-row">
    <div class="col-sm-12 col-md-12 col-lg-12 col-xl-12 tm-block-col">
      <div class="tm-bg-primary-dark tm-block tm-block-products" style="max-height: 1000px;">
        <h2 class="tm-block-title">Roles</h2>
        <div class="tm-product-table-container">
          <table id="table1" class="table table-hover tm-table-small tm-product-table">
            <thead>
              <tr>
                <th scope="col">&nbsp;</th>
                <th scope="col" style="width: 100%;">ROLE</th>
                <th scope="col">ACTION</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
              <tr>
                <th scope="row"><input type="checkbox" /></th>
                <td><b>{{ item.get_name_display }}</b></td>
                <td><a href="/administration/roles/edit/{{ item.id }}/" class="tm-order-edit-link">
                    <i class="far fa-edit tm-order-edit-icon"></i>
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <!-- table container -->
        <div class="d-grid gap-2">
          <a href="#" class="btn btn-primary text-uppercase mb-3" data-bs-target="#add-role" data-bs-toggle="modal"
            data-bs-dismiss="modal">Add new role</a>
          <button class="btn btn-primary text-uppercase" data-bs-target="#rem-role" data-bs-toggle="modal"
            data-bs-dismiss="modal">
            Delete selected roles
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Pagination Start -->
{% if paginator %}
<div class="col-md-12">
  <nav>
    <ul class="pagination justify-content-center">
      {% if page.has_previous %}
      <li class="page-item">
        <a class="page-link" href="javascript:moveToPage({{ page.number|add:'-1'}});">Previous</a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <a class="page-link" href="" tabindex="-1">Previous</a>
      </li>
      {% endif %}
      {% for pag in pages %}
      {% if page.number|stringformat:'s' == pag|stringformat:'s' %}
      <li class="page-item active"><a class="page-link" href="">{{ pag }}</a></li>
      {% else %}
      <li class="page-item {% if '...' == pag|stringformat:'s' %}disabled{% endif %}"><a class="page-link" href="javascript:moveToPage({{ pag }});">
          {{ pag }}</a></li>
      {% endif %}
      {% endfor %}
      {% if page.has_next %}
      <li class="page-item">
        <a class="page-link" href="javascript:moveToPage({{ page.number|add:'1'}});">Next</a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <a class="page-link" href="">Next</a>
      </li>
      {% endif %}
    </ul>
  </nav>
</div>
{% endif %}
<!-- Modal -->
<div class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" id="add-role" tabindex="-1"
  aria-labelledby="add-order" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Role</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="add-order-form" action="/administration/orders/add/" onsubmit="selectAll();" method="post">
        <div class="modal-body">
          <label>Items:</label>
          <div>
            <select id="add-order-items" name="items[]" multiple>
            </select>
          </div>
          <label>User:</label>
          <div class="ui-widget">
            <input name="user" id="user">
          </div>
          <label>Status:</label>
          <div>
            <select id="add-order-statuses" name="status">
              {% for id, name in statuses.items %}
              <option value="{{ id }}">{{ name }}</option>
              {% endfor %}
            </select>
          </div><br>
          <button type="button" class="btn btn-primary" data-bs-target="#add-order-orderitem" data-bs-toggle="modal"
            data-bs-dismiss="modal">Add Item</button>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          {% csrf_token %}
          <button type="submit" class="btn btn-primary">Add</button>
        </div>
      </form>
    </div>
  </div>
</div>
  <div class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" id="add-order-orderitem" tabindex="-1"
    aria-labelledby="add-order-orderitem" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="remove-cat-title">Add Order</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label>Product:</label>
          <div>
            <input name="orderitem-select" id="orderitem-select" placeholder="Product Name">
          </div>
          <label>Quantity:</label>
          <div>
            <input type="number" id="orderitem-quantity" name="orderitem-quantity" placeholder="Quantity">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-target="#add-order" data-bs-toggle="modal"
            data-bs-dismiss="modal" data-bs-dismiss="modal">Back</button>
          <button type="button" data-bs-target="#add-order" data-bs-toggle="modal" data-bs-dismiss="modal"
            onclick="addOrderItemModal(this);" class="btn btn-primary">Add</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" id="rem-role" tabindex="-1"
    aria-labelledby="rem-role" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="remove-cat-title">Delete Orders</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h4><b>Are you sure?</b></h4>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Back</button>
          <form id="rem-role-form" action="/administration/roles/del/" method="post"
            onsubmit="return deleteRoles(this);">
            {% csrf_token %}
            <button type="submit" data-bs-dismiss="modal" class="btn btn-primary">Delete</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
  var id = {};

  function addOrderItemModal(elem) {
    option = document.createElement('option');
    e = document.getElementById('orderitem-select');
    q = document.getElementById('orderitem-quantity');
    items = document.getElementById('add-order-items');

    if(!q.value || !e.value)
      return;

    for (var i = 0; i < items.length; i++) {
      if (items.options[i].text.startsWith(e.value)) {
        items.options[i].text = e.value + ', ' + (parseInt(items.options[i].text.split(', ')[1]) + parseInt(q.value));
        items.options[i].value = e.value + ', ' + items.options[i].text.split(', ')[1];
        return;
      }
    }

    option.text = e.value + ', ' + q.value;
    option.value = id[e.value] + ', ' + q.value;
    option.selected = 'true'
    items.add(option);
  }

  function selectAll() {
    options = document.getElementById('add-order-items').getElementsByTagName('option');
    for (i = 0; i < options.length; i++) {
      options[i].selected = 'true';
    }
  }

    function deleteRoles(elem) {
      var table = document.getElementById('table1');
      var ok = false;

      for (const inp of table.getElementsByTagName('input')) {
        if (!inp.checked)
          continue;

        var row = inp.parentElement.parentElement;
        var elems = row.getElementsByTagName('td');

        for (const elem of elems) {
          if("id" in elem.dataset) {
            var id = elem.innerText.match(/\d+/)[0];
          }
        }

        input = document.createElement('input');
        input.hidden = 'hidden';
        input.type = 'number';
        input.defaultValue = id;
        input.name = 'id';
        document.getElementById('rem-role-form').appendChild(input);
        ok = true;
      }

      return ok;
    }

    function checkOrderFilter(form) {
      for (const elem of form.elements) {
        if (elem.value === '')
          elem.disabled = true;
      }
    }

    // Users autocomplete
    $( function() {
    var cache = {};
    $( "input[name='user']" ).autocomplete({
      source: "/administration/accounts/get/",
      minLength: 3,
      source: function( request, response ) {
        var term = request.term;
        if ( term in cache ) {
          response( cache[ term ] );
          return;
        }
 
        $.getJSON( "/administration/accounts/get/", request, function( data, status, xhr ) {
          cache[ term ] = data;
          response( data );
        });
      }
    });

    var cache1 = {};
    $( "#orderitem-select" ).autocomplete({
      source: "/administration/products/get/",
      minLength: 2,
      source: function( request, response ) {
        var term = request.term;
        if ( term in cache1 ) {
          response( cache1[ term ] );
          return;
        }
 
        $.getJSON( "/administration/products/get/", request, function( data, status, xhr ) {
          cache1[ term ] = data;
          response( data );
        });
      },
      select: function(request, responce) {
        id[responce.item.value] = responce.item.id;
    }
    });
  } );
  </script>

  {% endblock %}